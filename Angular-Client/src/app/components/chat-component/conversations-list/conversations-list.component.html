<div class="conversations-container">
    <div class="conversations-header">
        <h3 class="header-title">
            <span class="chat-icon">ðŸ’¬</span>
            Chats
        </h3>
        <div class="user-profile-section">
            <div class="current-user-info">
                <div class="current-user-avatar">
                    {{ getCurrentUserInitials() }}
                </div>
                <span class="current-user-name">{{ currentUserName }}</span>
                <button class="logout-btn" (click)="onLogout()" title="Logout" aria-label="Logout">
                    <svg viewBox="0 0 24 24" width="16" height="16">
                        <path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H4v16h10v-2h2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h10z"/>
                    </svg>
                </button>
            </div>
            <button class="create-group-btn" (click)="onCreateGroupClick()" aria-label="Create group">
                <svg viewBox="0 0 24 24" width="18" height="18">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
            </button>
        </div>
    </div>

    <div class="conversations-list">
        <div class="empty-state" *ngIf="combinedList.length === 0">
            <div class="empty-icon">ðŸ“­</div>
            <p class="empty-message">No chats yet</p>
            <p class="empty-subtitle">Start a chat or create a group</p>
        </div>

        <div class="conversation-item" *ngFor="let item of combinedList; trackBy: trackByItemId; let i = index"
            (click)="onItemClick(item)">

            <div class="conversation-avatar">
                <div class="avatar-container" [class.group-avatar]="isConversation(item) && item.type === 'group'"
                    [class.user-avatar]="isUser(item)">
                    {{ getItemInitials(item) }}

                    <!-- Online indicator for users -->
                    <div class="online-indicator" *ngIf="isUser(item) && item.isOnline"></div>

                    <!-- Online indicator for one-to-one conversations -->
                    <div class="online-indicator"
                        *ngIf="isConversation(item) && item.type === 'one-to-one' && isConversationOnline(item)"></div>

                    <!-- Group indicator -->
                    <div class="group-indicator" *ngIf="isConversation(item) && item.type === 'group'">
                        <svg viewBox="0 0 24 24" width="12" height="12">
                            <path
                                d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm5 7c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="conversation-info">
                <div class="conversation-header-row">
                    <div class="conversation-name">{{ getItemName(item) }}</div>
                    <div class="conversation-time" *ngIf="isConversation(item) && item.lastMessage">
                        {{ getLastMessageTime(item) }}
                    </div>
                </div>

                <div class="conversation-details">
                    <!-- Group conversation details -->
                    <div class="last-message"
                        *ngIf="isConversation(item) && item.type === 'group' && item.lastMessage; else groupNoMessage">
                        <span class="message-preview">
                            <span class="sender-name">{{ getSenderName(item.lastMessage.senderId) }}:</span>
                            {{ item.lastMessage.content }}
                        </span>
                    </div>

                    <!-- One-to-one conversation details -->
                    <div class="last-message"
                        *ngIf="isConversation(item) && item.type === 'one-to-one' && item.lastMessage; else oneToOneNoMessage">
                        <span class="message-preview">
                            {{ item.lastMessage.content }}
                        </span>
                    </div>

                    <!-- User item (no conversation yet) -->
                    <div class="no-message" *ngIf="isUser(item)">
                        <span class="no-message-text">
                            Click to start chatting
                        </span>
                    </div>

                    <!-- No message templates -->
                    <ng-template #groupNoMessage>
                        <div class="no-message" *ngIf="isConversation(item) && item.type === 'group'">
                            <span class="group-members-preview">
                                {{ getGroupMembersPreview(item) }}
                            </span>
                        </div>
                    </ng-template>

                    <ng-template #oneToOneNoMessage>
                        <div class="no-message" *ngIf="isConversation(item) && item.type === 'one-to-one'">
                            <span class="no-message-text">No messages yet</span>
                        </div>
                    </ng-template>

                    <div class="conversation-badges">
                        <!-- Admin indicator for groups -->
                        <div class="admin-badge-list" *ngIf="isConversation(item) && item.type === 'group' && isCurrentUserGroupAdmin(item)" title="You are an admin">
                            ðŸ‘‘ Admin
                        </div>

                        <!-- Group member count -->
                        <div class="group-badge" *ngIf="isConversation(item) && item.type === 'group'">
                            <svg viewBox="0 0 24 24" width="12" height="12">
                                <path
                                    d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm5 7c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2z" />
                            </svg>
                            {{ item.participants.length }} members
                        </div>

                        <!-- Unread messages for conversations -->
                        <div class="unread-badge"
                            *ngIf="isConversation(item) && item.unreadCount && item.unreadCount > 0">
                            {{ item.unreadCount > 99 ? '99+' : item.unreadCount }}
                        </div>

                        <!-- New message indicator for users -->
                        <div class="new-user-badge" *ngIf="isUser(item)">
                            <svg viewBox="0 0 24 24" width="12" height="12">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="conversation-chevron">
                <svg viewBox="0 0 24 24" width="16" height="16">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                </svg>
            </div>
        </div>
    </div>

    <!-- Floating Action Button for Creating Groups -->
    <div class="fab-container">
        <button class="fab" (click)="onCreateGroupClick()" title="Create Group">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path
                    d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm5 7c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2z" />
                <circle cx="12" cy="19" r="2" />
            </svg>
        </button>
    </div>

    <!-- Create Group Modal -->
    <div class="modal-overlay" *ngIf="showCreateGroupModal" (click)="closeCreateGroupModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Create New Group</h2>
                <button class="close-btn" (click)="closeCreateGroupModal()" aria-label="Close modal">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M18.3 5.71a1 1 0 00-1.42-1.42L12 9.17 7.11 4.29A1 1 0 005.7 5.71L10.59 12l-4.89 4.89a1 1 0 101.42 1.42L12 14.83l4.89 4.88a1 1 0 001.42-1.42L13.41 12l4.89-4.89z"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label for="groupName">Group Name *</label>
                    <input 
                        type="text" 
                        id="groupName"
                        [(ngModel)]="groupCreationData.name" 
                        placeholder="Enter group name"
                        maxlength="50"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label for="groupDescription">Description (Optional)</label>
                    <textarea 
                        id="groupDescription"
                        [(ngModel)]="groupCreationData.description" 
                        placeholder="Enter group description"
                        maxlength="200"
                        rows="3"
                        class="form-input"></textarea>
                </div>

                <div class="form-group">
                    <label>Select Members</label>
                    <div class="users-selection">
                        <div 
                            *ngFor="let user of onlineUsers" 
                            class="user-checkbox"
                            [class.selected]="isUserSelected(user.userId)">
                            <input 
                                type="checkbox"
                                [id]="'user-' + user.userId"
                                [checked]="isUserSelected(user.userId)"
                                (change)="toggleUserSelection(user.userId)">
                            <label [for]="'user-' + user.userId" class="user-label">
                                <div class="user-avatar">{{ user.username.charAt(0).toUpperCase() }}</div>
                                <span class="user-name">{{ user.username }}</span>
                                <div class="user-status" [class.online]="user.isOnline"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button 
                    class="btn btn-secondary" 
                    (click)="closeCreateGroupModal()"
                    [disabled]="isCreatingGroup">
                    Cancel
                </button>
                <button 
                    class="btn btn-primary" 
                    (click)="createGroup()"
                    [disabled]="!groupCreationData.name.trim() || selectedUsers.length === 0 || isCreatingGroup">
                    <span *ngIf="isCreatingGroup">Creating...</span>
                    <span *ngIf="!isCreatingGroup">Create Group</span>
                </button>
            </div>
        </div>
    </div>
</div>