<div class="chat-box">
    <div class="chat-header">
        <button class="back-button" (click)="onBackClick()" aria-label="Back to chat list">
            <svg class="back-icon" viewBox="0 0 24 24" width="20" height="20">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
            </svg>
            <span class="back-text">Back</span>
        </button>

        <div class="chat-user-info">
            <div class="user-avatar" [class.group-avatar]="isGroupChat">
                {{ getInitials(chatTitle) }}
            </div>
            <div class="user-details">
                <h3 class="user-name">{{ chatTitle }}</h3>
                <span class="status-indicator" [class.online]="!isGroupChat && selectedUser?.isOnline"
                    [class.offline]="!isGroupChat && !selectedUser?.isOnline" [class.group-info]="isGroupChat">
                    <span class="status-dot" *ngIf="!isGroupChat"></span>
                    {{ chatSubtitle }}
                    <!-- Admin indicator for current user -->
                    <span class="admin-badge" *ngIf="isGroupChat && isGroupAdmin()" title="You are an admin">
                        üëë Admin
                    </span>
                </span>
            </div>
            
            <!-- Group Actions -->
            <div class="group-actions" *ngIf="isGroupChat">
                <button class="rename-button" 
                        *ngIf="isGroupAdmin()" 
                        (click)="startRenameGroup()" 
                        aria-label="Rename group"
                        title="Click to rename group">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                </button>

                <!-- Admin: Manage Members Button -->
                <button class="manage-members-button" 
                        *ngIf="isGroupAdmin()" 
                        (click)="startManageMembers()" 
                        aria-label="Manage members"
                        title="Click to manage group members">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 5V4C19 2.9 18.1 2 17 2S15 2.9 15 4V5L13 7V9C13 9.6 13.4 10 14 10H20C20.6 10 21 9.6 21 9ZM8 7C9.66 7 11 8.34 11 10C11 11.66 9.66 13 8 13C6.34 13 5 11.66 5 10C5 8.34 6.34 7 8 7ZM8 14.2C10.5 14.2 15.2 15.5 15.2 18V20H.8V18C.8 15.5 5.5 14.2 8 14.2Z"/>
                    </svg>
                </button>

                <!-- Admin: Invite Members Button -->
                <button class="invite-members-button" 
                        *ngIf="isGroupAdmin()" 
                        (click)="startManageInvitations()" 
                        aria-label="Create invitation link"
                        title="Create invitation link for group">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M9,12L11,14L15,10M13,1L21,5V11C21,16.55 17.16,21.74 12,23C6.84,21.74 3,16.55 3,11V5L11,1H13M11,7V13L17,10L11,7Z"/>
                    </svg>
                </button>

                <!-- Admin: Delete Group Button -->
                <button class="delete-group-button" 
                        *ngIf="isGroupAdmin()" 
                        (click)="deleteGroup()" 
                        [disabled]="isDeletingGroup"
                        aria-label="Delete group"
                        title="Delete this group permanently">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9H16V19H8V9M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z"/>
                    </svg>
                </button>

                <!-- Game Toggle Button (Group Only) -->
                <button class="game-toggle-button" 
                        *ngIf="isGroupChat" 
                        (click)="toggleGameSection()" 
                        [class.active]="isGameSectionVisible"
                        aria-label="Toggle game section"
                        title="Word guessing game">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M7.5,13.5L9,12L7.5,10.5L12,6L16.5,10.5L15,12L16.5,13.5L12,18L7.5,13.5Z"/>
                    </svg>
                </button>

                <!-- Non-Admin: View Members Button -->
                <button class="view-members-button" 
                        *ngIf="!isGroupAdmin()" 
                        (click)="startViewMembers()" 
                        aria-label="View members"
                        title="View group members">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                    </svg>
                </button>

                <!-- Non-Admin: Leave Group Button -->
                <button class="leave-group-button" 
                        *ngIf="!isGroupAdmin()" 
                        (click)="leaveGroupAsUser()" 
                        [disabled]="isLeavingGroup"
                        aria-label="Leave group"
                        title="Leave this group">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M17,7L15.59,5.59L9,12.17L5.41,8.58L4,10L9,15L17,7M21,3C21,1.89 20.1,1 19,1H5A2,2 0 0,0 3,3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V3Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div #messageSection class="messages-section">
        <div class="messages-container">
            <div class="message-wrapper" *ngFor="let msg of messages; trackBy: trackByMessageId">
                <div class="message-content" [class.current-user]="msg.senderId === currentUserId"
                    [class.other-user]="msg.senderId !== currentUserId" [class.group-message]="isGroupChat">

                    <!-- Group message sender info -->
                    <div class="message-sender" *ngIf="isGroupChat && msg.senderId !== currentUserId">
                        <span class="sender-name">{{ getSenderName(msg.senderId) }}</span>
                        <span class="admin-indicator" *ngIf="isUserAdmin(msg.senderId)" title="Admin">üëë</span>
                    </div>

                    <div class="message-bubble">
                        <div class="message-text">{{ msg.content }}</div>
                        <div class="message-time">{{ getMessageTime(msg.timestamp) }}</div>
                    </div>
                </div>
            </div>

            <div class="empty-state" *ngIf="messages.length === 0">
                <div class="empty-icon">üí¨</div>
                <p>No messages yet. Start the conversation!</p>
            </div>
        </div>

        <!-- Scroll to bottom button -->
        <button class="scroll-to-bottom-btn" 
                *ngIf="showScrollToBottom" 
                (click)="onScrollToBottom()"
                aria-label="Scroll to bottom">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
        </button>
    </div>

    <!-- Game Section (Group Only) -->
    <div class="game-section" *ngIf="isGameSectionVisible && isGroupChat">
        <!-- Create Game Button -->
        <div class="game-controls" *ngIf="!isCreatingGame">
            <button class="btn-create-game" (click)="startCreateGame()">
                üéÆ Create Word Game
            </button>
        </div>

        <!-- Create Game Form -->
        <div class="create-game-form" *ngIf="isCreatingGame">
            <div class="form-header">
                <h4>Create Word Game</h4>
                <button class="close-btn" (click)="cancelCreateGame()">&times;</button>
            </div>
            
            <div class="form-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="targetWord">Target Word (Optional)</label>
                        <input 
                            type="text" 
                            id="targetWord"
                            [(ngModel)]="gameCreationForm.targetWord"
                            [maxlength]="gameCreationForm.wordLength"
                            placeholder="Leave empty for random word"
                            class="form-input">
                        <small class="form-note">Leave empty to use a random word</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="wordLength">Word Length</label>
                        <input 
                            type="number" 
                            id="wordLength"
                            [(ngModel)]="gameCreationForm.wordLength"
                            min="3" 
                            max="10"
                            class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="maxAttempts">Max Attempts</label>
                        <input 
                            type="number" 
                            id="maxAttempts"
                            [(ngModel)]="gameCreationForm.maxAttempts"
                            min="3" 
                            max="10"
                            class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="timeLimit">Time Limit (seconds)</label>
                        <input 
                            type="number" 
                            id="timeLimit"
                            [(ngModel)]="gameCreationForm.timeLimit"
                            min="60" 
                            max="1800"
                            class="form-input">
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-secondary" (click)="cancelCreateGame()">Cancel</button>
                    <button 
                        class="btn btn-primary" 
                        (click)="createWordGame()"
                        [disabled]="!canCreateGame()">
                        Create Game
                    </button>
                </div>
            </div>
        </div>

        <!-- Word Game Component -->
        <app-word-game 
            *ngIf="!isCreatingGame"
            [conversationId]="selectedConversation?._id || ''">
        </app-word-game>
    </div>

    <div class="message-input-container">
        <div class="message-input">
            <input [(ngModel)]="message" placeholder="Type a message..." (keydown.enter)="sendMessage()"
                class="message-input-field" maxlength="1000" autocomplete="off" />

            <button (click)="sendMessage()" class="send-button" [disabled]="!message.trim()" aria-label="Send message">
                <svg class="send-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Group Rename Modal -->
    <div class="group-rename-modal" *ngIf="isRenamingGroup" (click)="cancelRename()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Rename Group</h3>
                <button class="close-btn" (click)="cancelRename()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label for="newGroupName">Group Name</label>
                    <input 
                        type="text" 
                        id="newGroupName"
                        [(ngModel)]="newGroupName"
                        placeholder="Enter new group name"
                        maxlength="50"
                        class="form-input"
                        (keydown.enter)="renameGroup()">
                    <small class="char-count">{{ newGroupName.length }}/50</small>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="cancelRename()">Cancel</button>
                <button 
                    class="btn btn-primary" 
                    (click)="renameGroup()"
                    [disabled]="!canRename() || isRenameLoading"
                    [class.loading]="isRenameLoading">
                    {{ isRenameLoading ? 'Renaming...' : 'Rename' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Member Management Modal -->
    <div class="member-management-modal" *ngIf="isManagingMembers" (click)="cancelManageMembers()">
        <div class="modal-content large-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ isViewingMembers ? 'Group Members' : 'Manage Group Members' }}</h3>
                <button class="close-btn" (click)="cancelManageMembers()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Current Members Section -->
                <div class="members-section">
                    <h4>{{ isViewingMembers ? 'Members' : 'Current Members' }} ({{ selectedConversation?.participants?.length || 0 }})</h4>
                    <div class="members-list">
                        <div class="member-item" *ngFor="let participant of selectedConversation?.participants">
                            <div class="member-info">
                                <div class="member-avatar">
                                    {{ getUserInitials(participant.username) }}
                                </div>
                                <div class="member-details">
                                    <span class="member-name">{{ participant.username }}</span>
                                    <span class="member-role" [class.admin-role]="participant.role === 'admin'">
                                        {{ participant.role === 'admin' ? 'üëë Admin' : 'Member' }}
                                    </span>
                                </div>
                            </div>
                            <!-- Remove button only for admins -->
                            <button 
                                class="remove-member-btn" 
                                *ngIf="!isViewingMembers && participant._id !== currentUserId && !isMemberActionLoading"
                                (click)="removeMember(participant._id)"
                                title="Remove {{ participant.username }} from group">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add Members Section - Only for Admins -->
                <div class="add-members-section" *ngIf="!isViewingMembers && availableUsers.length > 0">
                    <h4>Add New Members</h4>
                    <div class="loading" *ngIf="isLoadingUsers">Loading available users...</div>
                    
                    <div class="available-users-list" *ngIf="!isLoadingUsers">
                        <div class="user-item" 
                             *ngFor="let user of availableUsers" 
                             [class.selected]="isUserSelected(user.userId)"
                             (click)="toggleUserSelection(user.userId)">
                            <div class="user-info">
                                <div class="user-avatar">
                                    {{ getUserInitials(user.username) }}
                                </div>
                                <div class="user-details">
                                    <span class="user-name">{{ user.username }}</span>
                                    <span class="user-status" [class.online]="user.isOnline">
                                        {{ user.isOnline ? 'Online' : 'Offline' }}
                                    </span>
                                </div>
                            </div>
                            <div class="selection-indicator">
                                <svg *ngIf="isUserSelected(user.userId)" viewBox="0 0 24 24" width="20" height="20">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="no-users-message" *ngIf="!isViewingMembers && !isLoadingUsers && availableUsers.length === 0">
                    <p>All available users are already in this group.</p>
                </div>

                <!-- View-only info message for non-admins -->
                <div class="view-only-message" *ngIf="isViewingMembers">
                    <p><i>üëÅÔ∏è You can view group members but cannot modify them. Only admins can add or remove members.</i></p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="cancelManageMembers()">Close</button>
                <!-- Add button only for admins -->
                <button 
                    class="btn btn-primary" 
                    *ngIf="!isViewingMembers && selectedUsersToAdd.length > 0"
                    (click)="addSelectedUsers()"
                    [disabled]="isMemberActionLoading"
                    [class.loading]="isMemberActionLoading">
                    {{ isMemberActionLoading ? 'Adding...' : `Add ${selectedUsersToAdd.length} User${selectedUsersToAdd.length > 1 ? 's' : ''}` }}
                </button>
            </div>
        </div>
    </div>

    <!-- Invitation Management Modal -->
    <div class="invitation-management-modal" *ngIf="isManagingInvitations" (click)="stopManageInvitations()">
        <div class="modal-content large-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>üîó Group Invitation Management</h3>
                <button class="close-btn" (click)="stopManageInvitations()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Create New Invitation -->
                <div class="create-invitation-section">
                    <h4>Create New Invitation Link</h4>
                    <div class="invitation-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expiresInDays">Expires In (Days)</label>
                                <select id="expiresInDays" [(ngModel)]="invitationForm.expiresInHours" class="form-select">
                                    <option [ngValue]="24">1 Day</option>
                                    <option [ngValue]="72">3 Days</option>
                                    <option [ngValue]="168">1 Week</option>
                                    <option [ngValue]="720">1 Month</option>
                                    <option [ngValue]="8760">1 Year</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="maxUses">Usage Limit</label>
                                <select id="maxUses" [(ngModel)]="invitationForm.usageLimit" class="form-select">
                                    <option [ngValue]="1">1 Use</option>
                                    <option [ngValue]="5">5 Uses</option>
                                    <option [ngValue]="10">10 Uses</option>
                                    <option [ngValue]="25">25 Uses</option>
                                    <option [ngValue]="50">50 Uses</option>
                                </select>
                            </div>
                        </div>
                        <button 
                            class="btn btn-primary create-invite-btn"
                            (click)="createInvitation()"
                            [disabled]="isCreatingInvitation"
                            [class.loading]="isCreatingInvitation">
                            {{ isCreatingInvitation ? 'Creating...' : '‚ú® Create Invitation Link' }}
                        </button>
                    </div>
                </div>

                <!-- Active Invitations -->
                <div class="active-invitations-section" *ngIf="invitations.length > 0">
                    <h4>Active Invitation Links ({{ invitations.length }})</h4>
                    <div class="invitations-list">
                        <div class="invitation-item" *ngFor="let invitation of invitations">
                            <div class="invitation-info">
                                <div class="invitation-link">
                                    <strong>üîó Invitation Link:</strong>
                                    <div class="link-container">
                                        <input 
                                            #linkInput
                                            type="text" 
                                            [value]="invitation.inviteLink" 
                                            readonly 
                                            class="link-input">
                                        <button 
                                            class="copy-btn"
                                            (click)="copyInvitationLink(invitation)"
                                            title="Copy link">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                                <div class="invitation-details">
                                    <span class="detail-item">
                                        <strong>Expires:</strong> {{ getTimeAgo(invitation.expiresAt) }}
                                        <span *ngIf="isInvitationExpired(invitation.expiresAt)" class="expired-label">(Expired)</span>
                                    </span>
                                    <span class="detail-item">
                                        <strong>Usage:</strong> 
                                        {{ invitation.usedCount }}{{ invitation.maxUses ? '/' + invitation.maxUses : ' (unlimited)' }}
                                    </span>
                                    <span class="detail-item">
                                        <strong>Created:</strong> {{ getTimeAgo(invitation.createdAt) }}
                                    </span>
                                </div>
                            </div>
                            <div class="invitation-actions">
                                <button 
                                    class="btn btn-danger btn-sm"
                                    (click)="deactivateInvitation(invitation._id)"
                                    [disabled]="revokingInvitationId === invitation._id"
                                    title="Revoke invitation">
                                    {{ revokingInvitationId === invitation._id ? '‚è≥' : 'üóëÔ∏è' }} Revoke
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- No Active Invitations -->
                <div class="no-invitations" *ngIf="invitations.length === 0 && !isInvitationActionLoading">
                    <p>No active invitation links. Create one to invite new members!</p>
                </div>

                <!-- Loading State -->
                <div class="loading-invitations" *ngIf="isInvitationActionLoading">
                    <p>Loading invitations...</p>
                </div>

                <!-- Join Requests Section -->
                <div class="join-requests-section" *ngIf="joinRequests.length > 0">
                    <h4>‚è≥ Pending Join Requests ({{ joinRequests.length }})</h4>
                    <div class="join-requests-list">
                        <div class="join-request-item" *ngFor="let request of joinRequests">
                            <div class="request-info">
                                <div class="user-info">
                                    <div class="user-avatar">{{ getUserInitials(request.userId.username) }}</div>
                                    <div class="user-details">
                                        <strong>{{ request.userId.username }}</strong>
                                        <span class="user-email">{{ request.userId.email }}</span>
                                        <div class="request-message" *ngIf="request.message">
                                            <em>"{{ request.message }}"</em>
                                        </div>
                                        <span class="request-time">Requested {{ getTimeAgo(request.createdAt) }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="request-actions">
                                <button 
                                    class="btn btn-success btn-sm"
                                    (click)="processJoinRequest(request._id, 'approve')"
                                    [disabled]="isProcessingRequest"
                                    title="Approve request">
                                    ‚úÖ Approve
                                </button>
                                <button 
                                    class="btn btn-danger btn-sm"
                                    (click)="processJoinRequest(request._id, 'reject')"
                                    [disabled]="isProcessingRequest"
                                    title="Reject request">
                                    ‚ùå Reject
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- No Join Requests -->
                <div class="no-join-requests" *ngIf="joinRequests.length === 0 && !isInvitationActionLoading">
                    <p>No pending join requests.</p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="stopManageInvitations()">Close</button>
            </div>
        </div>
    </div>
</div>